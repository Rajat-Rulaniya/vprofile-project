def COLOR_MAP = [
    'SUCCESS': 'good',
    'FAILURE': 'danger',
]

pipeline {
    agent any

    environment {
        NEXUS_CREDENTIALS = credentials('NEXUS_CREDENTIALS')
        NEXUS_USER = "${NEXUS_CREDENTIALS_USR}"
        NEXUS_PASS = "${NEXUS_CREDENTIALS_PSW}"
        RELEASE_REPO = 'vprofile-release'
    }

    stages {
        stage("Fetch latest build version") {
            steps {
                script {
                    env.BUILD_VERSION = readFile('/var/lib/jenkins/latestBuildVprofile.txt').trim()
                }
            }
        }

        stage("Ansible Deploy to Production server") {
            steps {
                ansiblePlaybook(
                    playbook: './ansible/site.yml',
                    inventory: './ansible/prod.inventory',
                    credentialsId: 'applogin-prod',
                    colorized: true,
                    disableHostKeyChecking: true,
                    installation: 'ansible',
                    extraVars: [
                        USER: env.NEXUS_USER,
                        PASS: env.NEXUS_PASS,
                        NEXUS_URL: env.NEXUS_PRIVATE_URL,
                        RELEASE_REPO: env.RELEASE_REPO,
                        groupid: "ARTIFACTS",
                        subgroupid: "java-app",
                        vprofile_version: env.BUILD_ID,
                        build_version: env.BUILD_VERSION,
                    ]
                )
            }
        }
    }
}